{% extends "base.html" %}

{% block title %}Analysis Results{% endblock %}

{% block content %}
<div class="results-center-wrapper">
  <div class="results-card">
    <div class="page-header">
      <h1>Respiratory Sound Analysis Report</h1>
      <p class="page-subtitle" style="color: #555; background: #f5f5f5; padding: 0.5em 1em; border-radius: 4px;">
        AI-Assisted Diagnostic Analysis
      </p>
    </div>
    <div class="result-section">
      
      <!-- Primary Disease Diagnosis Section -->
      <div class="disease-diagnosis-group">
        <h3><span class="disease-icon">ü©∫</span> Disease Diagnosis</h3>
        <div class="result-type">
          <span class="result-type-icon">‚úÖ</span>
          <span class="result-type-title">{{ disease_diagnosis }}</span>
        </div>
        <p class="result-type-desc" style="margin-bottom: 0.5em;">Detected Respiratory Condition</p>
      </div>
      <hr class="section-divider">

      <div class="confidence-group">
        <h3>Diagnostic Confidence Level</h3>
        <div class="confidence-score">
          {{ "%.2f"|format(disease_confidence|float) }}%
        </div>
        <p class="confidence-explanation" style="font-size: 0.97em; color: #333;">
          This indicates how confident the AI model is about this diagnosis.
        </p>
      </div>
      <hr class="section-divider">

      <div class="clinical-group">
        <h3><span class="clinical-group-icon">ü©∫</span> Clinical Interpretation</h3>
        <strong>{{ clinical_interpretation }}</strong>
        <div>{{ clinical_detail }}</div>
      </div>
      <hr class="section-divider">
      
      <div class="notice-group">
        <h3><span class="notice-group-icon">‚ö†Ô∏è</span> Important Medical Notice</h3>
        <p>
          This AI-assisted analysis is a diagnostic aid tool only. Always consult with a qualified healthcare professional for proper diagnosis and treatment planning.
        </p>
      </div>
      <hr class="section-divider">

      <!-- Audio Playback Section -->
      <div class="audio-playback-group">
        <h3><span class="audio-playback-icon">üîä</span> Audio Playback</h3>
        <p style="color: #555; margin-bottom: 1rem;">Listen to the recorded respiratory sounds</p>
        {% if audio_file_path %}
        <div class="audio-player-container">
          <audio id="lungSoundPlayer" controls controlsList="nodownload" preload="metadata">
            <source src="{{ url_for('static', filename=audio_file_path|normalize_static_path) }}" type="audio/wav">
            <source src="{{ url_for('static', filename=audio_file_path|normalize_static_path) }}" type="audio/mpeg">
            <source src="{{ url_for('static', filename=audio_file_path|normalize_static_path) }}" type="audio/flac">
            Your browser does not support the audio element.
          </audio>
          <div class="audio-controls-info">
            <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
              <i class="fas fa-info-circle"></i> Use the controls to play, pause, and adjust volume
            </p>
          </div>
        </div>
        {% else %}
        <p style="text-align: center; color: #666;">Audio file not available.</p>
        {% endif %}
      </div>
      <hr class="section-divider">

      <!-- Visualizations Section -->
      <div class="visualization-group">
        <h3><span class="visualization-group-icon">üìä</span> Audio Visualizations</h3>
        <div class="visualization-container">
          {% if waveform_path %}
          <div class="visualization-item">
            <h4>Audio Waveform</h4>
            <img src="{{ url_for('static', filename=waveform_path) }}" alt="Waveform Plot" class="visualization-img">
          </div>
          {% endif %}

          {% if spectrogram_path %}
          <div class="visualization-item">
            <h4>Mel Spectrogram (Frequency Analysis)</h4>
            <img src="{{ url_for('static', filename=spectrogram_path) }}" alt="Mel Spectrogram Plot" class="visualization-img">
          </div>
          {% endif %}

          {% if not waveform_path and not spectrogram_path %}
          <p style="text-align: center; color: #666;">Visualizations could not be generated for this recording.</p>
          {% endif %}
        </div>
      </div>
      <hr class="section-divider">
      
      <div class="info-group">
        <h3><span class="info-group-icon">‚ÑπÔ∏è</span> Recording Information</h3>
        <ul class="info-list">
          <li><strong>Patient Name:</strong> {{ patient_name }}</li>
          <li><strong>Patient ID:</strong> {{ patient_id }}</li>
          <li><strong>Age:</strong> {{ age or 'N/A' }} years</li>
          <li><strong>Gender:</strong> {{ gender or 'N/A' }}</li>
          <li><strong>Recording Location:</strong> {{ recording_location }}</li>
          <li><strong>File Name:</strong> {{ filename }}</li>
          <li><strong>Analysis Date:</strong> {{ analysis_date }}</li>
          <li><strong>File Size:</strong> {{ file_size }}</li>
        </ul>
      </div>
      <hr class="section-divider">

      <div class="info-group">
        <h3><span class="info-group-icon">üë®‚Äç‚öïÔ∏è</span> Clinician Information</h3>
        <ul class="info-list">
          <li><strong>Clinician Name:</strong> Dr. {{ clinician_name }}</li>
          <li><strong>Email:</strong> {{ clinician_email }}</li>
          <li><strong>Phone:</strong> {{ clinician_phone }}</li>
        </ul>
      </div>
    </div>
    
    <div class="action-buttons" style="text-align:center; margin-top:2rem;">
      <button class="btn-primary" onclick="window.print()" style="padding: 1rem 2.5rem; font-size: 1.1rem;">
        <i class="fas fa-print"></i> Print Professional Report
      </button>
      <button class="btn-secondary" onclick="location.href='{{ url_for('clinical_guidelines') }}#{{ disease_diagnosis|lower }}'" style="margin-left:1rem; padding: 1rem 2.5rem; font-size: 1.1rem;">
        <i class="fas fa-book-medical"></i> View Disease Guidelines
      </button>
      <button class="btn-secondary" onclick="location.href='{{ url_for('dashboard') }}'" style="margin-left:1rem; padding: 1rem 2.5rem; font-size: 1.1rem;">
        <i class="fas fa-home"></i> Back to Dashboard
      </button>
    </div>

    <!-- Print-only footer information -->
    <div class="print-footer" style="display: none;">
      <div style="margin-top: 2cm; padding-top: 0.5cm; border-top: 2px solid #4A90E2; text-align: center; font-size: 10pt; color: #666;">
        <p><strong>Report Generated:</strong> {{ analysis_date }}</p>
        <p><strong>System:</strong> AST Lung Sound Analysis & Diagnosis Platform</p>
        <p style="font-style: italic; margin-top: 0.3cm;">This report is computer-generated and should be reviewed by a qualified medical professional.</p>
      </div>
    </div>
  </div>
</div>

<style>
/* Audio Player Styling */
.audio-playback-group {
  background: #f8f9fa;
  padding: 1.5rem;
  border-radius: 8px;
  border-left: 4px solid #4A90E2;
}

.audio-player-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 1rem;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

#lungSoundPlayer {
  width: 100%;
  max-width: 600px;
  height: 54px;
  outline: none;
}

#lungSoundPlayer::-webkit-media-controls-panel {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

#lungSoundPlayer::-webkit-media-controls-play-button,
#lungSoundPlayer::-webkit-media-controls-current-time-display,
#lungSoundPlayer::-webkit-media-controls-time-remaining-display,
#lungSoundPlayer::-webkit-media-controls-timeline,
#lungSoundPlayer::-webkit-media-controls-volume-slider {
  filter: brightness(1.2);
}

.audio-controls-info {
  width: 100%;
  max-width: 600px;
  text-align: center;
}

@media print {
  .print-footer {
    display: block !important;
    page-break-inside: avoid !important;
  }

  .audio-playback-group {
    display: none !important;
  }
}
</style>
{% endblock %}
